{
    "collab_server" : "",
    "contents" : "library(tm)\nlibrary(RWeka)\nlibrary(magrittr)\nlibrary(Matrix)\nlibrary(glmnet)\nlibrary(ROCR)\nlibrary(ggplot2)\n\n# Read in the data\ndata <- read.csv('../input/StockMarket/Combined_News_DJIA.csv', stringsAsFactors = FALSE)\n\n# Make 'Date' column a Date object to make train/test splitting easier\ndata$Date <- as.Date(data$Date)\n\n# Combine headlines into one text blob for each day and add sentence separation token\ndata$all <- paste(data$Top1, data$Top2, data$Top3, data$Top4, data$Top5, data$Top6,\n                  data$Top7, data$Top8, data$Top9, data$Top10, data$Top11, data$Top12, \n                  data$Top13, data$Top14, data$Top15, data$Top16, data$Top17, data$Top18,\n                  data$Top19, data$Top20, data$Top21, data$Top22, data$Top23, data$Top24,\n                  data$Top25, sep=' <s> ')\n\n# Get rid of those pesky b's and backslashes \ndata$all <- gsub('b\"|b\\'|\\\\\\\\|\\\\\"', \"\", data$all)\n\n# Get rid of all punctuation except headline separators\ndata$all <- gsub(\"([<>])|[[:punct:]]\", \"\\\\1\", data$all)\n\n# Reduce to only the three columns we need. \ndata <- data[, c('Date', 'Label', 'all')]\n\n####################### shift the labels ####################\n# PREVIOUS:\n#             if close value of 2/25 is less than 2/24\n#             then the Label of 2/25 = 0\n# problem:  x and y of a observation(day) are not much related\n# NOW:     \n#             if close value of 2/25 is less than 2/24\n#             then the Label of 2/24 = 0\n# solve: x and y of a observation(day) has more relation\n# can think that y=1 means x(the news) is positive, on the contrary, x is negative\nfor(i in 1:(nrow(data)-1)){\n    data$Label[i] <- data$Label[i+1]\n}\n#############################################################\noptions(mc.cores=1)\n\nBigramTokenizer <- function(x) NGramTokenizer(x, Weka_control(min = 2, max = 2))\n\ncontrol <- list(\n  tokenize=BigramTokenizer,\n  bounds = list(global = c(20, 500)),\n  \n  # ME\n  stopwords = c(stopwords(kind = 'SMART'), '<s>')\n  \n)\n\n# https://stackoverflow.com/questions/42604439/document-term-matrix-in-r-bigram-tokenizer-not-working\ndtm <- VCorpus(VectorSource(data$all)) %>%\n  tm_map(removeNumbers) %>%\n  tm_map(stripWhitespace) %>%\n  tm_map(content_transformer(tolower)) %>%\n  DocumentTermMatrix(control=control)\n\nsplit_index <- data$Date <= '2014-12-31'\n\n\nytrain <- as.factor(data$Label[split_index])\nxtrain <- Matrix(as.matrix(dtm)[split_index, ], sparse=TRUE)\n\nytest <- as.factor(data$Label[!split_index])\nxtest <- Matrix(as.matrix(dtm)[!split_index, ], sparse=TRUE)\n\n\n# Because of the different results come from different seeds (randomness in cross validation), \n# we do it 5 times and get the mean of those auc's.\naucMean <- 0\nfor(i in 1:5){  \n\n  set.seed(3*i)\n  \n  # Train the model\n  glmnet.fit <- cv.glmnet(x=xtrain, y=ytrain, family='binomial', alpha=0)\n\n  # Generate predictions\n  preds <- predict(glmnet.fit, newx=xtest, type='response', s=\"lambda.min\")\n\n  # Put results into dataframe for plotting.\n  results <- data.frame(pred=preds, actual=ytest)\n\n  prediction <- prediction(preds, ytest)\n  perf <- performance(prediction, measure = \"tpr\", x.measure = \"fpr\")\n\n  auc <- performance(prediction, measure = \"auc\")\n  auc <- auc@y.values[[1]]\n\n  aucMean <- aucMean + auc\n}\naucMean <- aucMean / 5\n\n\nroc.data <- data.frame(fpr=unlist(perf@x.values),\n                       tpr=unlist(perf@y.values))\n\nggplot(roc.data, aes(x=fpr, ymin=0, ymax=tpr)) +\n  geom_ribbon(alpha=0.2) +\n  geom_line(aes(y=tpr)) +\n  geom_abline(slope=1, intercept=0, linetype='dashed') +\n  ggtitle(\"ROC Curve\") +\n  ylab('True Positive Rate') +\n  xlab('False Positive Rate')\n\n#dtm$j[dtm$i==1945]\n#dtm$dimnames$Terms[dtm$j[dtm$i==1945]]",
    "created" : 1505972548306.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3020528898",
    "id" : "402121E",
    "lastKnownWriteTime" : 1505988537,
    "last_content_update" : 1505988537499,
    "path" : "C:/Users/drjui/Desktop/MachineLearning/R_Projects/StockMarket/shiftLabels_Rscript.R",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 3,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}